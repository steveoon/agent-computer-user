name: Build Windows x64

on:
  workflow_dispatch: # 手动触发
  release:
    types: [published] # semantic-release 发布时自动触发

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env files
        shell: bash
        run: |
          cat > .env << 'ENVEOF'
          ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}"
          DEEPSEEK_API_KEY="${{ secrets.DEEPSEEK_API_KEY }}"
          DASHSCOPE_API_KEY="${{ secrets.DASHSCOPE_API_KEY }}"
          GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          MOONSHOT_API_KEY="${{ secrets.MOONSHOT_API_KEY }}"
          OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}"
          E2B_API_KEY="${{ secrets.E2B_API_KEY }}"
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          NEXT_PUBLIC_SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
          NEXT_PUBLIC_SUPABASE_ANON_KEY="${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}"
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          FEISHU_BOT_WEBHOOK="${{ secrets.FEISHU_BOT_WEBHOOK }}"
          WECHAT_BOT_WEBHOOK="${{ secrets.WECHAT_BOT_WEBHOOK }}"
          DULIDAY_TOKEN="${{ secrets.DULIDAY_TOKEN }}"
          OPEN_API_AUTH_URL="${{ secrets.OPEN_API_AUTH_URL }}"
          ENABLE_SCHEDULER="${{ secrets.ENABLE_SCHEDULER }}"
          USE_PLAYWRIGHT_MCP="${{ secrets.USE_PLAYWRIGHT_MCP }}"
          ENVEOF
          cp .env .env.production

      - name: Build Electron app
        run: pnpm electron:build
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Package Windows x64
        run: pnpm exec electron-builder --win --publish never

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-${{ github.ref_name }}
          path: |
            dist/*.exe
            dist/*.yaml
          retention-days: 30
